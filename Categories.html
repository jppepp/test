<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #eef1ec;
      font-family: 'Segoe UI', sans-serif;
    }
    header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 1050;
      border-bottom: 1px solid #ccc;
      transition: transform 0.3s ease-in-out;
    }
    .header-hidden {
      transform: translateY(-100%);
    }
    main {
      padding-top: 5rem;
      padding-bottom: 3rem;
    }
    .compare-box {
      background: white;
      padding: 2rem 3rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: auto;
      width: 95%;
      max-width: 1400px;
      border-radius: 8px;
    }
    canvas {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 1rem;
    }
    .loading-spinner {
      display: none;
      text-align: center;
      margin: 1rem 0;
    }
    .error-message {
      display: none;
      color: #dc3545;
      margin-top: 1rem;
    }
    .year-select-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .hidden {
      display: none !important;
    }
  
    .chart-controls {
      display: flex;
      gap: 2rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .annotation {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #666;
    }
    .year-notice {
      text-align: center;
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: -1rem;
      margin-bottom: 1rem;
      font-style: italic;
    }
    </style>
</head>
<body>

<header id="mainHeader" class="py-3 px-4 d-flex justify-content-between align-items-center">
  <h1 class="fs-5 mb-0">–°–†–ê–í–ù–ï–ù–ò–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô –ò–ù–§–õ–Ø–¶–ò–ò</h1>
  <nav>
    <a class="mx-2 text-decoration-none text-dark" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
    <a class="mx-2 text-decoration-none text-dark" href="index.html#cards-section">–°–µ—Ä–≤–∏—Å</a>
    <a class="btn btn-outline-dark btn-sm" href="index.html#contact">–ö–æ–Ω—Ç–∞–∫—Ç</a>
  </nav>
</header>

<main>
  <div class="compare-box">
    <form class="row g-3 mb-4">
      <div class="col-md-3">
        <label for="country1" class="form-label">–°—Ç—Ä–∞–Ω–∞ 1:</label>
        <select class="form-select" id="country1">
          <option data-value="Brazil">–ë—Ä–∞–∑–∏–ª–∏—è</option>
          <option data-value="Russia" selected>–†–æ—Å—Å–∏—è</option>
          <option data-value="India">–ò–Ω–¥–∏—è</option>
          <option data-value="China">–ö–∏—Ç–∞–π</option>
          <option data-value="Indonesia">–ò–Ω–¥–æ–Ω–µ–∑–∏—è</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="country2" class="form-label">–°—Ç—Ä–∞–Ω–∞ 2:</label>
        <select class="form-select" id="country2">
          <option data-value="Brazil">–ë—Ä–∞–∑–∏–ª–∏—è</option>
          <option data-value="Russia">–†–æ—Å—Å–∏—è</option>
          <option data-value="India">–ò–Ω–¥–∏—è</option>
          <option data-value="China" selected>–ö–∏—Ç–∞–π</option>
          <option data-value="Indonesia">–ò–Ω–¥–æ–Ω–µ–∑–∏—è</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select class="form-select" id="category">
          <option data-value="CPI Inflation" selected>–û–±—â–∞—è</option>
          <option data-value="CPI Housing Utilities">–ñ–ö–•</option>
          <option data-value="CPI Transportation">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
          <option data-value="Food Inflation">–ï–¥–∞</option>
          <option data-value="PPI Inflation">–¶–µ–Ω—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</option>
        </select>
      </div>
      <div class="col-md-3" id="periodContainer">
        <label class="form-label">–ü–µ—Ä–∏–æ–¥:</label>
        <div class="year-select-container">
          <select class="form-select" id="startYear"></select>
          <span>‚Äî</span>
          <select class="form-select" id="endYear"></select>
        </div>
      </div>
    </form>

    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <div id="yearNotice" class="year-notice hidden">–î–∞–Ω–Ω—ã–µ –∑–∞ <span id="dataYear">2025</span> –≥–æ–¥</div>

    <div class="chart-controls">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleDelta">
        <label class="form-check-label" for="toggleDelta">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –∏–Ω—Ñ–ª—è—Ü–∏–∏ (%)</label>
      </div>
      <button class="btn btn-outline-primary btn-sm" id="playBtn">‚ñ∂Ô∏è –ê–Ω–∏–º–∞—Ü–∏—è</button>
      <button class="btn btn-outline-success btn-sm" id="forecastBtn">üîÆ –ü—Ä–æ–≥–Ω–æ–∑</button>
    </div>

    <canvas id="comparisonChart" height="240"></canvas>
    <div class="annotation">
      <strong>üìù –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:</strong> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–±—â–µ–π –∏–Ω—Ñ–ª—è—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑ –∏ –∞–Ω–∏–º–∞—Ü–∏—è.
    </div>
  </div>
</main>

<footer class="text-center text-muted py-4">
  ¬© 2025 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–ª—è—Ü–∏–∏
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
function interpolateZeroValues(values) {
  return values.map((value, index, array) => {
    if (value !== 0 && value !== null) return value;
    
    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –Ω–µ–Ω—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let prevValue = null;
    for (let i = index - 1; i >= 0; i--) {
      if (array[i] !== 0 && array[i] !== null) {
        prevValue = array[i];
        break;
      }
    }
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–µ–µ –Ω–µ–Ω—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let nextValue = null;
    for (let i = index + 1; i < array.length; i++) {
      if (array[i] !== 0 && array[i] !== null) {
        nextValue = array[i];
        break;
      }
    }
    
    // –ï—Å–ª–∏ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã, –≤—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ
    if (prevValue !== null && nextValue !== null) {
      return (prevValue + nextValue) / 2;
    }
    
    // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (prevValue !== null) return prevValue;
    
    // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if (nextValue !== null) return nextValue;
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
    return 0;
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
const ctx = document.getElementById("comparisonChart").getContext("2d");
let chart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [] },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top' },
      title: {
        display: true,
        text: '–ò–Ω—Ñ–ª—è—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∑–∞ –ø–µ—Ä–∏–æ–¥'
      }
    }
  }
});

let showDelta = false;
let animationInterval = null;
let rawChartData = null;
let forecastVisible = false;
let originalChartData = null;

function computeDeltas(values) {
  return values.map((v, i, arr) =>
    i === 0 || v === null || arr[i - 1] === null ? null : parseFloat((v - arr[i - 1]).toFixed(2))
  );
}

function computeForecast(values, years) {
  const recent = values.slice(-3);
  if (recent.includes(null)) return { labels: [], values: [] };
  const lastYear = years[years.length - 1];
  const avgDiff = (recent[2] - recent[0]) / 2;
  return {
    labels: [lastYear + 1, lastYear + 2],
    values: [recent[2] + avgDiff, recent[2] + 2 * avgDiff]
  };
}

function addForecastToChart(chartData) {
  const forecast1 = computeForecast(chartData.datasets[0].data, chartData.labels);
  const forecast2 = computeForecast(chartData.datasets[1].data, chartData.labels);
  chartData.labels.push(...forecast1.labels);
  chartData.datasets.push({
    label: chartData.datasets[0].label + ' (–ø—Ä–æ–≥–Ω–æ–∑)',
    data: [
      ...chartData.datasets[0].data.slice(0), // –∫–æ–ø–∏—è –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
      ...forecast1.values
    ],
    borderColor: 'rgba(75,192,192,0.5)',
    borderDash: [5,5],
    fill: false,
    tension: 0.3
  });
  chartData.datasets.push({
    label: chartData.datasets[1].label + ' (–ø—Ä–æ–≥–Ω–æ–∑)',
    data: [
      ...chartData.datasets[1].data.slice(0),
      ...forecast2.values
    ],
    borderColor: 'rgba(255,99,132,0.5)',
    borderDash: [5,5],
    fill: false,
    tension: 0.3
  });
}

function updateChartWithForecast(chart, chartData) {
  addForecastToChart(chartData);
  chart.data = chartData;
  chart.update();
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ–¥–æ–≤ –æ—Ç 2015 –¥–æ 2025
function generateYearOptions() {
  const startYearSelect = document.getElementById('startYear');
  const endYearSelect = document.getElementById('endYear');
  
  // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
  startYearSelect.innerHTML = '';
  endYearSelect.innerHTML = '';
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ–¥—ã –æ—Ç 2015 –¥–æ 2025
  for (let year = 2015; year <= 2025; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±–∞ —Å–µ–ª–µ–∫—Ç–∞
    startYearSelect.appendChild(option.cloneNode(true));
    endYearSelect.appendChild(option);
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  startYearSelect.value = 2015;
  endYearSelect.value = 2025;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏
  updateYearOptions();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞
function updateYearOptions() {
  const startYear = parseInt(document.getElementById('startYear').value);
  const endYear = parseInt(document.getElementById('endYear').value);
  const endYearSelect = document.getElementById('endYear');
  
  // –î–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –≥–æ–¥–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≥–æ–¥—ã >= –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ
  Array.from(endYearSelect.options).forEach(option => {
    option.disabled = parseInt(option.value) < startYear;
  });
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ —Å—Ç–∞–ª–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
  if (endYear < startYear) {
    endYearSelect.value = startYear;
  }
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
async function fetchAndUpdateChart() {
  const country1Select = document.getElementById("country1");
  const country2Select = document.getElementById("country2");
  const categorySelect = document.getElementById("category");
  const startYear = parseInt(document.getElementById("startYear").value);
  const endYear = parseInt(document.getElementById("endYear").value);

  const country1 = country1Select.selectedOptions[0].dataset.value;
  const country2 = country2Select.selectedOptions[0].dataset.value;
  const category = categorySelect.selectedOptions[0].dataset.value;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  document.getElementById("loadingSpinner").style.display = "block";

  let url = "";
  let raw = [];
  let dataYear = endYear; // –ì–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  
  try {
    if (category === "CPI Inflation") {
      url = `https://localhost:7227/api/inflation/compare-by-category?country1=${encodeURIComponent(country1)}&country2=${encodeURIComponent(country2)}&category=${encodeURIComponent(category)}&startYear=${startYear}&endYear=${endYear}`;
    } else {
      url = `https://localhost:7227/api/inflation/compare-by-category?country1=${encodeURIComponent(country1)}&country2=${encodeURIComponent(country2)}&category=${encodeURIComponent(category)}`;
    }

    const response = await fetch(url);
    if (!response.ok) throw new Error("API error");
    raw = await response.json();
    
    // –î–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ
    if (category !== "CPI Inflation") {
      dataYear = Math.max(...raw.map(item => item.year));
      raw = raw.filter(item => item.year === dataYear);
    }
  } catch (err) {
    console.warn("API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.");
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    if (category === "CPI Inflation") {
      for (let year = startYear; year <= endYear; year++) {
        raw.push(
          { year, rate: 3 + Math.random() * 3, country: country1 },
          { year, rate: 2 + Math.random() * 2, country: country2 }
        );
      }
    } else {
      dataYear = 2023;
      raw = [
        { year: dataYear, rate: 5 + Math.random() * 5, country: country1 },
        { year: dataYear, rate: 3 + Math.random() * 3, country: country2 }
      ];
    }
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
  const yearNotice = document.getElementById("yearNotice");
  const dataYearElement = document.getElementById("dataYear");
  
  if (category === "CPI Inflation") {
    yearNotice.classList.add("hidden");
  } else {
    dataYearElement.textContent = dataYear;
    yearNotice.classList.remove("hidden");
  }

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
  let labels, values1, values2;
  
  if (category === "CPI Inflation") {
    // –î–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ (–æ–±—â–∞—è –∏–Ω—Ñ–ª—è—Ü–∏—è)
    const data1 = raw.filter(r => r.country === country1);
    const data2 = raw.filter(r => r.country === country2);
    labels = [...new Set([...data1, ...data2].map(r => r.year))]
      .filter(y => y >= startYear && y <= endYear)
      .sort();
    
    values1 = labels.map(y => data1.find(r => r.year === y)?.rate ?? null);
    values2 = labels.map(y => data2.find(r => r.year === y)?.rate ?? null);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é –¥–ª—è –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    values1 = interpolateZeroValues(values1);
    values2 = interpolateZeroValues(values2);
  } else {
    // –î–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
    labels = [country1Select.value, country2Select.value];
    values1 = [raw.find(r => r.country === country1)?.rate ?? 0];
    values2 = [raw.find(r => r.country === country2)?.rate ?? 0];
  }

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  const isLineChart = category === "CPI Inflation";
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ / –ø—Ä–æ–≥–Ω–æ–∑–∞
  rawChartData = {
    labels: [...labels],
    datasets: [
      { label: country1Select.value, data: [...values1] },
      { label: country2Select.value, data: [...values2] }
    ]
  };

  chart.destroy();
  chart = new Chart(ctx, {
    type: isLineChart ? 'line' : 'bar',
    data: {
      labels: isLineChart ? labels : [categorySelect.selectedOptions[0].text],
      datasets: [
        {
          label: country1Select.value,
          data: isLineChart ? values1 : [values1[0]],
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.7)',
          fill: isLineChart,
          tension: 0.3
        },
        {
          label: country2Select.value,
          data: isLineChart ? values2 : [values2[0]],
          borderColor: 'rgba(255, 99, 132, 1)',
          backgroundColor: 'rgba(255, 99, 132, 0.7)',
          fill: isLineChart,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: {
          display: true,
          text: isLineChart 
            ? `–ò–Ω—Ñ–ª—è—Ü–∏—è (${categorySelect.selectedOptions[0].text}) –∑–∞ –ø–µ—Ä–∏–æ–¥ ${startYear}-${endYear}`
            : `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ ${categorySelect.selectedOptions[0].text} (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ)`
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const dataset = context.dataset.data;
              const index = context.dataIndex;
              const value = dataset[index];
              const delta = index > 0 && dataset[index - 1] != null
                ? (value - dataset[index - 1]).toFixed(2)
                : null;

              if (showDelta && delta !== null) {
                return `${context.dataset.label}: ${value.toFixed(2)} (Œî ${delta > 0 ? '+' : ''}${delta}%)`;
              }

              return `${context.dataset.label}: ${value.toFixed(2)}`;
            }
          }
        }
      },
      scales: isLineChart ? {} : {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function handleCategoryChange() {
  const categorySelect = document.getElementById("category");
  const periodContainer = document.getElementById("periodContainer");
  const isGeneralInflation = categorySelect.selectedOptions[0].dataset.value === "CPI Inflation";
  const forecastBtn = document.getElementById("forecastBtn");
  const playBtn = document.getElementById("playBtn");
  const deltaSwitch = document.getElementById("toggleDelta").parentElement;

  forecastBtn.style.display = isGeneralInflation ? "inline-block" : "none";
  playBtn.style.display = isGeneralInflation ? "inline-block" : "none";
  deltaSwitch.style.display = isGeneralInflation ? "inline-block" : "none";
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞
  periodContainer.classList.toggle("hidden", !isGeneralInflation);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
  fetchAndUpdateChart();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function initEventListeners() {
  document.getElementById('country1').addEventListener('change', fetchAndUpdateChart);
  document.getElementById('country2').addEventListener('change', fetchAndUpdateChart);
  document.getElementById('category').addEventListener('change', handleCategoryChange);
  
  document.getElementById('startYear').addEventListener('change', function() {
    updateYearOptions();
    fetchAndUpdateChart();
  });
  
  document.getElementById('endYear').addEventListener('change', fetchAndUpdateChart);

  document.getElementById("toggleDelta").addEventListener("change", e => {
    showDelta = e.target.checked;
    fetchAndUpdateChart();
  });

  let forecastVisible = false;
  let originalChartData = null;

  document.getElementById("forecastBtn").addEventListener("click", e => {
    e.preventDefault();
    if (!chart) return;

    if (!forecastVisible) {
      // Save original chart state deeply
      originalChartData = JSON.parse(JSON.stringify(chart.data));
      const forecastData = JSON.parse(JSON.stringify(chart.data));
      updateChartWithForecast(chart, forecastData);
      forecastVisible = true;
      e.target.textContent = "‚ùå –£–±—Ä–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑";
    } else {
      // Restore original chart
      chart.data.labels = [...originalChartData.labels];
      chart.data.datasets = originalChartData.datasets.map(ds => ({ ...ds }));
      chart.update();
      forecastVisible = false;
      e.target.textContent = "üîÆ –ü—Ä–æ–≥–Ω–æ–∑";
    }
  });

  document.getElementById("playBtn").addEventListener("click", e => {
    e.preventDefault();
    if (animationInterval) {
      clearInterval(animationInterval);
      animationInterval = null;
      e.target.textContent = "‚ñ∂Ô∏è –ê–Ω–∏–º–∞—Ü–∏—è";
      return;
    }
    let i = 0;
    animationInterval = setInterval(() => {
      if (i >= rawChartData.labels.length) {
        clearInterval(animationInterval);
        animationInterval = null;
        e.target.textContent = "‚ñ∂Ô∏è –ê–Ω–∏–º–∞—Ü–∏—è";
        return;
      }
      chart.data.labels = rawChartData.labels.slice(0, i + 1);
      chart.data.datasets[0].data = rawChartData.datasets[0].data.slice(0, i + 1);
      chart.data.datasets[1].data = rawChartData.datasets[1].data.slice(0, i + 1);
      chart.update();
      i++;
    }, 800);
    e.target.textContent = "‚è∏Ô∏è –ü–∞—É–∑–∞";
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  generateYearOptions();
  initEventListeners();
  handleCategoryChange();
  fetchAndUpdateChart();
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è header
  let lastScroll = 0;
  const header = document.getElementById("mainHeader");
  window.addEventListener("scroll", () => {
    const currentScroll = window.pageYOffset;
    if (currentScroll > lastScroll) {
      header.classList.add("header-hidden");
    } else {
      header.classList.remove("header-hidden");
    }
    lastScroll = currentScroll <= 0 ? 0 : currentScroll;
  });
});

</script>
</body>
</html>